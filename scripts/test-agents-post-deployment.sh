#!/bin/bash

# Post-Deployment Frontend Agent Testing Script
# Test agent functionality after deploying to remote server

REMOTE_SERVER="${1:-159.89.112.134}"
PORTAL_URL="http://$REMOTE_SERVER:8080"

echo "ðŸ§ª Post-Deployment Agent Testing"
echo "================================"
echo "Remote Server: $REMOTE_SERVER"
echo "Portal URL: $PORTAL_URL"
echo ""

echo "ðŸ“‹ STEP-BY-STEP AGENT TESTING"
echo "=============================="
echo ""

echo "STEP 1: Access Remote Portal"
echo "----------------------------"
echo "â€¢ Open: $PORTAL_URL"
echo "â€¢ Login: test@test.com / password"
echo "â€¢ Expected: Dashboard with 0 agents"
echo ""

echo "STEP 2: Test Generate Token (Our Fix)"
echo "-------------------------------------"
echo "â€¢ Navigate to Agents page"
echo "â€¢ Click 'Generate Token' button"
echo "â€¢ Expected: âœ… Token dialog appears (no HTTP 415 error)"
echo "â€¢ Expected: âœ… Valid provisioning token displayed"
echo ""

echo "STEP 3: Test Add Agent (Our Fix)"  
echo "--------------------------------"
echo "â€¢ Click 'Add Agent' button"
echo "â€¢ Expected: âœ… Form shows ALL fields:"
echo "  - Agent Name (required)"
echo "  - Description (optional)"
echo "  - Machine ID (required) â† NEW!"
echo "  - Machine Name (optional) â† NEW!"
echo "  - IP Address (optional) â† NEW!"
echo ""
echo "â€¢ Fill form with:"
echo "  Agent Name: 'Remote Test Agent'"
echo "  Machine ID: 'REMOTE-$(date +%s)'"
echo "  Machine Name: 'Remote Desktop'"
echo "  IP Address: '10.0.0.100'"
echo ""
echo "â€¢ Click 'Create'"
echo "â€¢ Expected: âœ… Agent created successfully"
echo "â€¢ Expected: âœ… No validation errors"
echo "â€¢ Expected: âœ… Agent appears in list"
echo ""

echo "STEP 4: Verify Dashboard Updates"
echo "--------------------------------"
echo "â€¢ Navigate to Dashboard" 
echo "â€¢ Expected: âœ… Total Agents: 1"
echo "â€¢ Expected: âœ… Statistics updated"
echo "â€¢ Expected: âœ… Recent activity shows agent creation"
echo ""

echo "STEP 5: Test Agent Management"
echo "-----------------------------"
echo "â€¢ Return to Agents page"
echo "â€¢ Expected: âœ… Agent listed with 'Offline' status"
echo "â€¢ Try editing agent (click menu â†’ Edit)"
echo "â€¢ Try viewing agent details"
echo "â€¢ Expected: âœ… All operations work"
echo ""

echo "ðŸ”„ AGENT STATUS PROGRESSION"
echo "==========================="
echo ""
echo "1. MANUAL AGENT (Web Portal Creation):"
echo "   Status: 'Offline' (normal - no real machine connected)"
echo "   Purpose: Test frontend functionality"
echo ""
echo "2. REAL AGENT (Windows Machine Connection):"
echo "   Status: 'Online' (when Windows agent connects)"
echo "   Purpose: Full end-to-end functionality"
echo ""

echo "ðŸŽ¯ NEXT STEPS FOR REAL AGENTS"
echo "============================="
echo ""
echo "To get 'Online' agents in frontend:"
echo ""
echo "1. Generate provisioning token in web portal"
echo "2. Install Windows agent on target machine:"
echo "   â€¢ Download agent files"
echo "   â€¢ Configure appsettings.json with:"
echo "     - PortalApiUrl: http://$REMOTE_SERVER:5000" 
echo "     - RelayServerUrl: wss://$REMOTE_SERVER:9443"
echo "     - ProvisioningToken: [generated token]"
echo "   â€¢ Install as Windows service"
echo "   â€¢ Start service"
echo ""
echo "3. Agent will appear in frontend with 'Online' status"
echo "4. You can then create RDP sessions to that machine"
echo ""

echo "âœ… SUCCESS CRITERIA"
echo "=================="
echo "Frontend shows agents correctly when:"
echo ""
echo "âœ… Empty list initially (normal)"
echo "âœ… Generate Token works without errors"
echo "âœ… Add Agent form has all required fields"  
echo "âœ… Manual agent creation works"
echo "âœ… Agent appears in list immediately"
echo "âœ… Dashboard statistics update"
echo "âœ… No JavaScript console errors"
echo "âœ… All navigation works smoothly"
echo ""

echo "ðŸŽ‰ DEPLOYMENT SUCCESS INDICATORS"
echo "================================"
echo ""
echo "Your deployment is successful when:"
echo ""
echo "1. âœ… Can access $PORTAL_URL from any browser"
echo "2. âœ… Login works without errors"
echo "3. âœ… Generate Token functionality works (our fix verified)"
echo "4. âœ… Add Agent functionality works (our fix verified)" 
echo "5. âœ… Database operations work (agents persist)"
echo "6. âœ… Real-time updates work (dashboard updates)"
echo "7. âœ… System ready for Windows agent connections"
echo ""

echo "ðŸ’¡ TESTING TIP"
echo "=============="
echo "Create multiple test agents to verify:"
echo "â€¢ List pagination works"
echo "â€¢ Search/filter functionality"
echo "â€¢ Bulk operations"
echo "â€¢ Performance with multiple agents"
echo ""

echo "ðŸ”— USEFUL TESTING URLS"
echo "======================"
echo "â€¢ Portal:     $PORTAL_URL"
echo "â€¢ API Health: $PORTAL_URL/api/health"
echo "â€¢ API Docs:   http://$REMOTE_SERVER:5000/swagger"
echo ""

if command -v open >/dev/null 2>&1; then
    echo "Opening remote portal for testing..."
    open "$PORTAL_URL"
elif command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$PORTAL_URL"
else
    echo "Please open $PORTAL_URL in your browser to start testing"
fi

echo ""
echo "ðŸŽ¯ Ready to test agent functionality on remote server!"
